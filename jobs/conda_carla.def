Bootstrap: docker
From: carlasim/carla:0.9.14

%setup
    wget https://repo.continuum.io/miniconda/Miniconda3-latest-Linux-x86_64.sh
    mv Miniconda3-latest-Linux-x86_64.sh ${APPTAINER_ROOTFS}/home/install_conda.sh

%files
    environment.yml /home/environment.yml

%environment
    export CARLA_ROOT="/home/carla"
    export CARLA_VERSION="0.9.14"

%post -c /bin/bash
    export HOME="/home"
    cd ~
    
    # Check GPU availability
    nvcc --version
    nvidia-smi

    # Install and setup conda
    bash ./install_conda.sh -b -p ./miniconda3
    rm ./install_conda.sh
    ./miniconda3/bin/conda init bash
    source ~/.bashrc

    # Setup conda environment
    conda env create -f /home/environment.yml

    # Setup run_python script
    echo '#!/bin/bash' > ~/run_python.sh
    echo "source /home/.bashrc" >> ~/run_python.sh
    echo "exec /home/carla/CarlaUE4.sh -RenderOffScreen -nosound & CARLA=\$!" >> ~/run_python.sh
    echo "conda activate curla" >> ~/run_python.sh
    echo "python -u \"\$@\"" >> ~/run_python.sh
    echo "kill \$CARLA" >> ~/run_python.sh
    echo "kill -9 \$(pgrep -f CarlaUE4)" >> ~/run_python.sh
    echo "conda deactivate" >> ~/run_python.sh
    chmod 775 ~/run_python.sh
    
%test
    echo "[MESSAGE] Starting test section"
    echo 'import torch' >> ~/cuda_test.py
    echo 'print("CUDA availability:", torch.cuda.is_available())' >> ~/cuda_test.py
    conda activate curla
    python ~/cuda_test.py
    conda deactivate
    

%runscript
    command="$1"
    if [ -z "$command" ]; then
        command="carla"
    else
        shift 1
    fi
    if [ $command = "carla" ]; then
        exec /home/carla/CarlaUE4.sh "$@"
    elif [ $command = "python" ]; then
        exec /home/run_python.sh "$@" > "/data/leuven/352/vsc35202/lib/curla/log_run_python_$(date +%m-%d_%H-%M).out" 2> "/data/leuven/352/vsc35202/lib/curla/log_run_python_$(date +%m-%d_%H-%M).err"
    else
        echo "Unknown run command '$command'; use 'carla' or 'python'."
    fi

%help
    This container sets up a conda environment in the base carla image.
    Usage:
        * `apptainer run --nv conda_carla.sif` launches a new instance of the CARLA server.
        * `apptainer run --nv conda_carla.sif carla [params]` launches a new instance of the
          CARLA server with the given parameters.
        * `apptainer run --nv conda_carla.sif python [params]` runs python in the conda
          environment with the given parameters.
